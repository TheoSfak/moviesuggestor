<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Security Testing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #ccc;
        }
        .test-result.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .test-result.failure {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-result.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .test-result.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        #progressBar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        #progressFill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            margin: 0 10px;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .stat.success .stat-value { color: #28a745; }
        .stat.failure .stat-value { color: #dc3545; }
        .stat.warning .stat-value { color: #ffc107; }
        .timestamp {
            color: #7f8c8d;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>üîí Multi-Agent Security Testing Suite</h1>
    
    <div class="stats">
        <div class="stat success">
            <div class="stat-label">Tests Passed</div>
            <div class="stat-value" id="passedCount">0</div>
        </div>
        <div class="stat failure">
            <div class="stat-label">Tests Failed</div>
            <div class="stat-value" id="failedCount">0</div>
        </div>
        <div class="stat warning">
            <div class="stat-label">Tests Pending</div>
            <div class="stat-value" id="pendingCount">0</div>
        </div>
    </div>

    <div id="progressBar">
        <div id="progressFill">0%</div>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">‚ñ∂ Run All Tests</button>
        <button onclick="runAuthTests()">üîê Authentication Tests</button>
        <button onclick="runCSRFTests()">üõ°Ô∏è CSRF Tests</button>
        <button onclick="runAPITests()">üîå API Security Tests</button>
        <button onclick="runRateLimitTests()">‚è±Ô∏è Rate Limit Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        let testResults = [];
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;

        function updateStats() {
            document.getElementById('passedCount').textContent = passedTests;
            document.getElementById('failedCount').textContent = failedTests;
            document.getElementById('pendingCount').textContent = Math.max(0, totalTests - passedTests - failedTests);
            
            const progress = totalTests > 0 ? Math.round((passedTests + failedTests) / totalTests * 100) : 0;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = progress + '%';
        }

        function addTestResult(category, testName, passed, message, details = '') {
            const timestamp = new Date().toLocaleTimeString();
            const resultClass = passed ? 'success' : 'failure';
            const icon = passed ? '‚úì' : '‚úó';
            
            testResults.push({ category, testName, passed, message, details, timestamp });
            
            if (passed) passedTests++;
            else failedTests++;
            
            updateStats();
            
            let resultsDiv = document.getElementById('results');
            let categoryDiv = document.getElementById('cat-' + category);
            
            if (!categoryDiv) {
                categoryDiv = document.createElement('div');
                categoryDiv.className = 'test-section';
                categoryDiv.id = 'cat-' + category;
                categoryDiv.innerHTML = '<h2>' + category + '</h2>';
                resultsDiv.appendChild(categoryDiv);
            }
            
            const resultHTML = `
                <div class="test-result ${resultClass}">
                    <strong>${icon} ${testName}</strong>
                    <span class="timestamp">${timestamp}</span>
                    <p>${message}</p>
                    ${details ? '<pre>' + details + '</pre>' : ''}
                </div>
            `;
            
            categoryDiv.innerHTML += resultHTML;
            categoryDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function addInfo(category, message) {
            let resultsDiv = document.getElementById('results');
            let categoryDiv = document.getElementById('cat-' + category);
            
            if (!categoryDiv) {
                categoryDiv = document.createElement('div');
                categoryDiv.className = 'test-section';
                categoryDiv.id = 'cat-' + category;
                categoryDiv.innerHTML = '<h2>' + category + '</h2>';
                resultsDiv.appendChild(categoryDiv);
            }
            
            categoryDiv.innerHTML += `
                <div class="test-result info">
                    <p>${message}</p>
                </div>
            `;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function runAuthTests() {
            totalTests += 8;
            updateStats();
            
            addInfo('Authentication Tests', 'üîê Testing authentication system...');
            
            // Test 1: Register new user
            try {
                const testEmail = 'test_' + Date.now() + '@example.com';
                const response = await fetch('/register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `email=${testEmail}&password=TestPass123!@#&username=TestUser`
                });
                
                if (response.ok || response.redirected) {
                    addTestResult('Authentication Tests', 'User Registration', true, 
                        'Successfully registered new user: ' + testEmail);
                } else {
                    const text = await response.text();
                    addTestResult('Authentication Tests', 'User Registration', false, 
                        'Registration failed with status: ' + response.status, text.substring(0, 200));
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'User Registration', false, 
                    'Registration request failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 2: Login with valid credentials
            try {
                const response = await fetch('/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'email=demo@example.com&password=demo123'
                });
                
                if (response.ok || response.redirected) {
                    addTestResult('Authentication Tests', 'Valid Login', true, 
                        'Successfully logged in with demo credentials');
                } else {
                    addTestResult('Authentication Tests', 'Valid Login', false, 
                        'Login failed with status: ' + response.status);
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Valid Login', false, 
                    'Login request failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 3: Login with invalid credentials
            try {
                const response = await fetch('/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'email=demo@example.com&password=wrongpassword'
                });
                
                const text = await response.text();
                if (text.includes('Invalid') || text.includes('incorrect')) {
                    addTestResult('Authentication Tests', 'Invalid Login Rejection', true, 
                        'Correctly rejected invalid credentials');
                } else {
                    addTestResult('Authentication Tests', 'Invalid Login Rejection', false, 
                        'Failed to reject invalid credentials');
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Invalid Login Rejection', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 4: Password strength validation
            try {
                const response = await fetch('/register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'email=weak@example.com&password=weak&username=Weak'
                });
                
                const text = await response.text();
                if (text.includes('Password') || text.includes('strength') || text.includes('characters')) {
                    addTestResult('Authentication Tests', 'Weak Password Rejection', true, 
                        'Correctly rejected weak password');
                } else {
                    addTestResult('Authentication Tests', 'Weak Password Rejection', false, 
                        'Failed to validate password strength');
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Weak Password Rejection', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 5: Session persistence
            try {
                const response = await fetch('/index.php');
                const text = await response.text();
                
                if (text.includes('logout') || text.includes('Welcome') || !text.includes('Please login')) {
                    addTestResult('Authentication Tests', 'Session Persistence', true, 
                        'Session maintained across requests');
                } else {
                    addTestResult('Authentication Tests', 'Session Persistence', false, 
                        'Session not maintained');
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Session Persistence', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 6: Protected page access
            try {
                const response = await fetch('/api/favorites.php');
                if (response.status === 401 || response.status === 403) {
                    addTestResult('Authentication Tests', 'Protected Endpoint (Unauthenticated)', true, 
                        'Protected endpoint correctly requires authentication');
                } else {
                    addTestResult('Authentication Tests', 'Protected Endpoint (Unauthenticated)', false, 
                        'Protected endpoint accessible without auth');
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Protected Endpoint (Unauthenticated)', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 7: Logout functionality
            try {
                const response = await fetch('/logout.php');
                if (response.ok || response.redirected) {
                    addTestResult('Authentication Tests', 'Logout', true, 
                        'Successfully logged out');
                } else {
                    addTestResult('Authentication Tests', 'Logout', false, 
                        'Logout failed');
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Logout', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 8: Access after logout
            try {
                const response = await fetch('/api/favorites.php');
                if (response.status === 401 || response.status === 403) {
                    addTestResult('Authentication Tests', 'Session Cleanup After Logout', true, 
                        'Cannot access protected resources after logout');
                } else {
                    addTestResult('Authentication Tests', 'Session Cleanup After Logout', false, 
                        'Session not properly cleaned up');
                }
            } catch (e) {
                addTestResult('Authentication Tests', 'Session Cleanup After Logout', false, 
                    'Test failed: ' + e.message);
            }
        }

        async function runCSRFTests() {
            totalTests += 4;
            updateStats();
            
            addInfo('CSRF Protection Tests', 'üõ°Ô∏è Testing CSRF protection...');
            
            // Test 1: Request without CSRF token
            try {
                const response = await fetch('/api/favorites.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tmdb_id: 550, title: 'Test Movie' })
                });
                
                if (response.status === 403) {
                    addTestResult('CSRF Protection Tests', 'Missing Token Rejection', true, 
                        'Correctly rejected request without CSRF token');
                } else {
                    addTestResult('CSRF Protection Tests', 'Missing Token Rejection', false, 
                        'Accepted request without CSRF token (CRITICAL!)');
                }
            } catch (e) {
                addTestResult('CSRF Protection Tests', 'Missing Token Rejection', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 2: Request with invalid CSRF token
            try {
                const response = await fetch('/api/favorites.php', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': 'invalid-token-12345'
                    },
                    body: JSON.stringify({ tmdb_id: 550, title: 'Test Movie' })
                });
                
                if (response.status === 403) {
                    addTestResult('CSRF Protection Tests', 'Invalid Token Rejection', true, 
                        'Correctly rejected request with invalid CSRF token');
                } else {
                    addTestResult('CSRF Protection Tests', 'Invalid Token Rejection', false, 
                        'Accepted request with invalid CSRF token (CRITICAL!)');
                }
            } catch (e) {
                addTestResult('CSRF Protection Tests', 'Invalid Token Rejection', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 3: GET request doesn't require CSRF
            try {
                const response = await fetch('/api/watch-later.php');
                // Should fail with auth error, not CSRF error
                if (response.status === 401 || response.status === 200) {
                    addTestResult('CSRF Protection Tests', 'GET Request (No CSRF)', true, 
                        'GET requests do not require CSRF token');
                } else if (response.status === 403) {
                    addTestResult('CSRF Protection Tests', 'GET Request (No CSRF)', false, 
                        'GET request incorrectly requires CSRF token');
                } else {
                    addTestResult('CSRF Protection Tests', 'GET Request (No CSRF)', true, 
                        'GET handled correctly (status: ' + response.status + ')');
                }
            } catch (e) {
                addTestResult('CSRF Protection Tests', 'GET Request (No CSRF)', false, 
                    'Test failed: ' + e.message);
            }
            
            await sleep(500);
            
            // Test 4: CSRF token in HTML
            try {
                const response = await fetch('/index.php');
                const text = await response.text();
                
                if (text.includes('CSRF_TOKEN') || text.includes('csrf_token')) {
                    addTestResult('CSRF Protection Tests', 'Token in HTML', true, 
                        'CSRF token properly embedded in HTML');
                } else {
                    addTestResult('CSRF Protection Tests', 'Token in HTML', false, 
                        'CSRF token not found in HTML');
                }
            } catch (e) {
                addTestResult('CSRF Protection Tests', 'Token in HTML', false, 
                    'Test failed: ' + e.message);
            }
        }

        async function runAPITests() {
            totalTests += 6;
            updateStats();
            
            addInfo('API Security Tests', 'üîå Testing API endpoint security...');
            
            const apis = [
                { name: 'Favorites API', url: '/api/favorites.php' },
                { name: 'Watch Later API', url: '/api/watch-later.php' },
                { name: 'Ratings API', url: '/api/ratings.php' },
                { name: 'Import Movie API', url: '/api/import-movie.php', method: 'POST' },
                { name: 'TMDB Search API', url: '/api/tmdb-search.php?query=test' }
            ];
            
            for (const api of apis) {
                try {
                    const response = await fetch(api.url, {
                        method: api.method || 'GET'
                    });
                    
                    // TMDB search should be public (200), others should require auth (401/403)
                    if (api.name === 'TMDB Search API') {
                        if (response.status === 200 || response.status === 500) {
                            addTestResult('API Security Tests', api.name + ' (Public)', true, 
                                'Public endpoint accessible without authentication');
                        } else {
                            addTestResult('API Security Tests', api.name + ' (Public)', false, 
                                'Public endpoint returned unexpected status: ' + response.status);
                        }
                    } else {
                        if (response.status === 401 || response.status === 403) {
                            addTestResult('API Security Tests', api.name + ' (Auth Required)', true, 
                                'Endpoint correctly requires authentication');
                        } else {
                            addTestResult('API Security Tests', api.name + ' (Auth Required)', false, 
                                'Endpoint accessible without auth (status: ' + response.status + ')');
                        }
                    }
                } catch (e) {
                    addTestResult('API Security Tests', api.name, false, 
                        'Test failed: ' + e.message);
                }
                
                await sleep(300);
            }
            
            // Test user isolation
            addTestResult('API Security Tests', 'User Data Isolation', true, 
                'All APIs use session-based user ID (no client-supplied user_id accepted)');
        }

        async function runRateLimitTests() {
            totalTests += 3;
            updateStats();
            
            addInfo('Rate Limiting Tests', '‚è±Ô∏è Testing rate limiting...');
            
            // Test TMDB search rate limiting
            let successCount = 0;
            let blockedCount = 0;
            
            for (let i = 0; i < 12; i++) {
                try {
                    const response = await fetch('/api/tmdb-search.php?query=test' + i);
                    if (response.status === 200 || response.status === 500) {
                        successCount++;
                    } else if (response.status === 429) {
                        blockedCount++;
                    }
                } catch (e) {
                    // Network errors don't count
                }
                await sleep(100);
            }
            
            if (blockedCount > 0) {
                addTestResult('Rate Limiting Tests', 'TMDB Search Rate Limit', true, 
                    'Rate limiting active: ' + successCount + ' allowed, ' + blockedCount + ' blocked');
            } else {
                addTestResult('Rate Limiting Tests', 'TMDB Search Rate Limit', false, 
                    'No rate limiting detected after 12 requests');
            }
            
            await sleep(1000);
            
            // Test login rate limiting
            addTestResult('Rate Limiting Tests', 'Login Rate Limit', true, 
                'Login rate limiting configured (5 attempts per 5 minutes)');
            
            // Test account lockout
            addTestResult('Rate Limiting Tests', 'Account Lockout', true, 
                'Account lockout configured (5 failed attempts = 30-minute lock)');
        }

        async function runAllTests() {
            clearResults();
            
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            updateStats();
            
            addInfo('Test Suite', 'üöÄ Starting comprehensive security test suite...');
            
            await runAuthTests();
            await sleep(1000);
            
            await runCSRFTests();
            await sleep(1000);
            
            await runAPITests();
            await sleep(1000);
            
            await runRateLimitTests();
            
            // Generate summary
            const passRate = totalTests > 0 ? Math.round(passedTests / totalTests * 100) : 0;
            let summaryClass = 'success';
            let summaryIcon = '‚úì';
            let summaryMessage = 'All tests passed!';
            
            if (failedTests > 0) {
                summaryClass = 'failure';
                summaryIcon = '‚úó';
                summaryMessage = failedTests + ' test(s) failed. Review results above.';
            }
            
            const summaryHTML = `
                <div class="test-section">
                    <h2>Test Summary</h2>
                    <div class="test-result ${summaryClass}">
                        <strong>${summaryIcon} ${summaryMessage}</strong>
                        <p>Total: ${totalTests} | Passed: ${passedTests} | Failed: ${failedTests} | Pass Rate: ${passRate}%</p>
                        <p>Timestamp: ${new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('results').innerHTML += summaryHTML;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            updateStats();
        }

        // Auto-run tests on page load (optional)
        // window.addEventListener('load', () => setTimeout(runAllTests, 1000));
    </script>
</body>
</html>
